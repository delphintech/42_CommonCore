services:
  nginx:
    container_name: nginx
    build: nginx/
    env_file: .env
    ports:
      - "4443:443"
      - "4444:444"
      - "4445:445"
      - "8080:80"
      - "8081:81"
    restart: always
    networks:
      - transcendance
    volumes:
      - ../logs/nginx:/var/log/nginx
    depends_on:
      - prometheus
      - alertmanager
      - kibana

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    expose:
      - "9090"
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=7d
    networks:
      - transcendance
    volumes:
      - ./prometheus:/etc/prometheus:ro
      - prometheus-vol:/prometheus

  node_exporter:
    image: prom/node-exporter
    container_name: node_exporter
    expose:
      - "9100"
    networks:
      - transcendance
  
  sqlite-exporter:
    build: ./sqlite-exporter
    container_name: sqlite-exporter
    expose:
      - "9560"
    volumes:
      - ../data:/data:ro
    networks:
      - transcendance

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    env_file: .env
    expose:
      - "3000"
    networks:
      - transcendance
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
      - grafana-vol:/var/lib/grafana
    depends_on:
      - prometheus

  alertmanager:
    build:
      context: ./alertmanager
    container_name: alertmanager
    env_file: .env
    expose:
      - "9093"
    networks:
      - transcendance
    depends_on:
      - prometheus

  elasticsearch:
    build: elasticsearch/
    container_name: elasticsearch
    expose:
      - "9200"
    restart: always
    env_file: .env
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      - elastic_vol:/usr/share/elasticsearch/data
    mem_limit: 2g
    networks:
      - transcendance
    healthcheck:
      test: ["CMD", "curl", "-sSf", "-u", "elastic:${ELASTIC_PASSWORD}", "http://localhost:9200"]
      interval: 10s
      timeout: 5s
      retries: 10

  kibana:
    image: docker.elastic.co/kibana/kibana:9.0.0
    container_name: kibana
    env_file: .env
    expose:
      - "5601"
    volumes:
      - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    depends_on:
      node:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sSf", "http://localhost:5601/api/status"]
      interval: 30s
      timeout: 10s
      retries: 20
    networks:
      - transcendance

  logstash:
    build: logstash/
    container_name: logstash
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    expose:
      - "9600"
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      - ../logs/nginx:/usr/share/logstash/logs
    networks:
      - transcendance

  import_dashboard:
    build: ./curl             
    container_name: curl
    depends_on:
      kibana:
        condition: service_healthy
      nginx:
        condition: service_started
    env_file: .env
    volumes:
      - ./kibana/dashboards/dashboard.ndjson:/dashboard.ndjson:ro
    networks:
      - transcendance

  node:
    container_name: node
    build: node/
    expose:
      - "3000"
    restart: always
    networks:
      - transcendance
    volumes:
      - node:/app
      - sqlite:/data
    depends_on:
      - sqlite

  sqlite:
    container_name: sqlite
    build: sqlite/
    restart: always
    networks:
      - transcendance
    volumes:
      - sqlite:/db

networks:
  transcendance:
    driver: bridge

volumes:
  node:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '${PWD}/app'
  sqlite:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '${PWD}/data'
  elastic_vol:
  prometheus-vol:
  grafana-vol: